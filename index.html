<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE secret - 統合サイト Vercel版</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Hiragino Sans", sans-serif;
            background: #000; color: #fff; min-height: 100vh;
            overflow-x: hidden;
        }
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255,20,147,0.1) 0%, rgba(0,0,0,0.8) 50%, #000 100%);
            z-index: -1;
        }
        .container {
            max-width: 1200px; margin: 0 auto; padding: 2rem;
            text-align: center; min-height: 100vh; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .logo {
            font-size: 3rem; font-weight: bold; margin-bottom: 1rem;
            background: linear-gradient(45deg, #ff1493, #ff69b4, #ff1493);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; text-shadow: 0 0 30px rgba(255,20,147,0.5);
            box-shadow: 0 0 20px rgba(255,20,147,0.3); inset 0 0 20px rgba(255,20,147,0.1);
            position: fixed; top: 20px; left: 20px; font-size: 1.3rem;
        }
        .login-container {
            background: rgba(255,20,147,0.1); padding: 3rem; border-radius: 20px;
            border: 1px solid rgba(255,20,147,0.3); backdrop-filter: blur(10px);
            box-shadow: 0 0 50px rgba(255,20,147,0.2); max-width: 500px; width: 100%;
        }
        .login-title {
            font-size: 2.5rem; margin-bottom: 1rem; color: #ff1493;
            background: linear-gradient(45deg, #ff1493, #ff69b4);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .login-subtitle { color: #ccc; margin-bottom: 2rem; text-align: left; }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        .form-group label {
            display: block; margin-bottom: 0.5rem; color: #ff1493; font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%; padding: 1rem; border: 2px solid rgba(255,20,147,0.3);
            border-radius: 10px; background: rgba(0,0,0,0.5); color: #fff;
            font-size: 1rem; transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: #ff1493; box-shadow: 0 0 20px rgba(255,20,147,0.3);
        }
        .btn {
            background: linear-gradient(45deg, #ff1493, #ff69b4); color: #fff;
            border: none; padding: 1rem 2rem; border-radius: 10px; font-size: 1.1rem;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease; margin: 0.5rem;
        }
        .btn:hover {
            box-shadow: 0 0 20px rgba(255,20,147,0.3); inset 0 0 20px rgba(255,20,147,0.1);
        }
        .btn:hover { cursor: pointer; transform: translateY(-2px); }
        .btn-hover { background: linear-gradient(45deg, #ff1493, #ff69b4); color: #fff; }
        .btn:hover { cursor: pointer; }
        .login-subtitle { color: #ccc; margin-bottom: 2rem; text-align: center; }
        .password-hint { color: #999; font-size: 0.9rem; margin-top: 1rem; text-align: center; }

        /* エディター画面のスタイル */
        .editor-container { display: none; max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .editor-header {
            text-align: center; margin-bottom: 2rem;
            background: rgba(255,20,147,0.1); padding: 2rem; border-radius: 15px;
            border: 1px solid rgba(255,20,147,0.3);
        }
        .editor-title {
            font-size: 2rem; color: #ff1493; margin-bottom: 1rem;
            background: linear-gradient(45deg, #ff1493, #ff69b4);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .status-indicator {
            background: #00ff00; color: #000; padding: 0.5rem 1rem;
            border-radius: 20px; font-weight: bold; display: inline-block;
        }
        .article-info {
            background: rgba(255,20,147,0.1); padding: 2rem; border-radius: 15px;
            border: 1px solid rgba(255,20,147,0.3); margin-bottom: 2rem;
        }
        .article-info h3 { color: #ff1493; margin-bottom: 1rem; text-align: center; }
        .toolbar {
            display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;
            justify-content: center; align-items: center;
        }
        .toolbar button {
            background: linear-gradient(45deg, #ff1493, #ff69b4); color: #fff;
            border: none; padding: 0.5rem 1rem; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: all 0.3s ease;
        }
        .toolbar button:hover {
            box-shadow: 0 0 15px rgba(255,20,147,0.5); transform: translateY(-1px);
        }
        .drop-zone {
            border: 2px dashed rgba(255,20,147,0.5); border-radius: 10px;
            padding: 2rem; text-align: center; margin-bottom: 1rem;
            background: rgba(255,20,147,0.05); transition: all 0.3s ease;
        }
        .drop-zone:hover { border-color: #ff1493; background: rgba(255,20,147,0.1); }
        .content-editor {
            width: 100%; min-height: 300px; padding: 1rem;
            border: 2px solid rgba(255,20,147,0.3); border-radius: 10px;
            background: rgba(0,0,0,0.3); color: #fff; font-size: 1rem;
            resize: vertical; outline: none;
        }
        .content-editor:focus { border-color: #ff1493; box-shadow: 0 0 20px rgba(255,20,147,0.3); }
        .char-counter { text-align: right; color: #999; margin-top: 0.5rem; }
        .action-buttons {
            display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;
            margin-top: 2rem;
        }
        .student-container { display: none; }
        .course-info {
            background: rgba(255,20,147,0.1); padding: 2rem; border-radius: 15px;
            border: 1px solid rgba(255,20,147,0.3); margin-bottom: 2rem; text-align: center;
        }
        .course-title { color: #ff1493; font-size: 1.5rem; margin-bottom: 1rem; }
        .articles-list { display: grid; gap: 1rem; }
        .article-card {
            background: rgba(255,20,147,0.1); padding: 1.5rem; border-radius: 10px;
            border: 1px solid rgba(255,20,147,0.3); text-align: left;
        }
        .article-card h4 { color: #ff1493; margin-bottom: 0.5rem; }
        .article-meta { color: #999; font-size: 0.9rem; margin-bottom: 1rem; }
        .article-content { color: #ccc; line-height: 1.6; }
    </style>
</head>
<body>
    <a href="#" class="logo">THE secret</a>

    <!-- ログイン画面 -->
    <div class="container" id="loginScreen">
        <div class="login-container">
            <h1 class="login-title">THE secret</h1>
            <p class="login-subtitle">統合サイト Vercel版 - 完全自動保存対応</p>
            
            <div class="form-group">
                <label for="password">パスワード</label>
                <input type="password" id="password" placeholder="パスワードを入力してください...">
            </div>
            
            <button class="btn" onclick="login()">Enter</button>
            
            <div class="password-hint">
                管理者: admin123 | コース1: course1 | コース2: course2 | コース3: course3
            </div>
        </div>
    </div>

    <!-- 管理者エディター画面 -->
    <div class="editor-container" id="adminEditor">
        <div class="editor-header">
            <h2 class="editor-title">TIPS Level Editor Vercel版</h2>
            <div class="status-indicator">🟢 Vercel API 接続済み - 完全自動保存 - インライン画像対応</div>
            <div style="margin-top: 1rem;">
                <button class="btn" onclick="logout()">管理者 - ログアウト</button>
            </div>
        </div>

        <div class="article-info">
            <h3>記事情報</h3>
            <div class="form-group">
                <label for="articleTitle">記事タイトル</label>
                <input type="text" id="articleTitle" placeholder="記事のタイトルを入力してください">
            </div>
            <div class="form-group">
                <label for="courseSelect">対象コース</label>
                <select id="courseSelect">
                    <option value="course1">コース1: 基礎編</option>
                    <option value="course2">コース2: 応用編</option>
                    <option value="course3">コース3: 上級編</option>
                </select>
            </div>
        </div>

        <div class="article-info">
            <h3>記事内容</h3>
            <div class="toolbar">
                <button onclick="formatText('bold')">太字</button>
                <button onclick="formatText('italic')">斜体</button>
                <button onclick="formatText('underline')">下線</button>
                <button onclick="formatText('red')">赤</button>
                <button onclick="formatText('blue')">青</button>
                <button onclick="resetEditor()">リセット</button>
                <button onclick="insertImage()">📷 画像選択</button>
                <button onclick="insertYouTube()">📺 YouTube</button>
            </div>
            
            <div class="drop-zone" id="dropZone">
                📷 画像をここにドラッグ&ドロップ または クリックして選択<br>
                テキスト内の任意の位置にも直接ドラッグできます
            </div>
            
            <div class="content-editor" id="contentEditor" contenteditable="true"></div>
            <div class="char-counter" id="charCounter">0 文字</div>
        </div>

        <div class="action-buttons">
            <button class="btn" onclick="saveToVercel()">Vercel API で保存</button>
            <button class="btn" onclick="previewArticle()">プレビュー</button>
            <button class="btn" onclick="newArticle()">新規作成</button>
            <button class="btn" onclick="listArticles()">記事一覧</button>
        </div>
    </div>

    <!-- 受講生画面 -->
    <div class="student-container" id="studentScreen">
        <div class="container">
            <div class="course-info">
                <h2 class="course-title" id="courseTitle">コース情報</h2>
                <p id="courseDescription">コースの説明</p>
                <button class="btn" onclick="logout()">ログアウト</button>
            </div>
            <div class="articles-list" id="articlesList">
                <p>記事を読み込み中...</p>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'login';

        function login() {
            const password = document.getElementById('password').value;
            
            if (password === 'admin123') {
                currentMode = 'admin';
                showAdminEditor();
            } else if (password === 'course1') {
                currentMode = 'student';
                showStudentScreen('course1', 'コース1: 基礎編', '恋愛の基本的な考え方とアプローチ方法を学びます');
            } else if (password === 'course2') {
                currentMode = 'student';
                showStudentScreen('course2', 'コース2: 応用編', '実践的な恋愛テクニックと心理学を学びます');
            } else if (password === 'course3') {
                currentMode = 'student';
                showStudentScreen('course3', 'コース3: 上級編', '高度な恋愛戦略と長期的な関係構築を学びます');
            } else {
                alert('パスワードが正しくありません');
            }
        }

        function showAdminEditor() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminEditor').style.display = 'block';
            document.getElementById('studentScreen').style.display = 'none';
            setupEditor();
        }

        function showStudentScreen(course, title, description) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminEditor').style.display = 'none';
            document.getElementById('studentScreen').style.display = 'block';
            
            document.getElementById('courseTitle').textContent = title;
            document.getElementById('courseDescription').textContent = description;
            
            loadArticles(course);
        }

        function logout() {
            currentMode = 'login';
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('adminEditor').style.display = 'none';
            document.getElementById('studentScreen').style.display = 'none';
            document.getElementById('password').value = '';
        }

        function setupEditor() {
            const editor = document.getElementById('contentEditor');
            const counter = document.getElementById('charCounter');
            
            editor.addEventListener('input', () => {
                counter.textContent = editor.textContent.length + ' 文字';
            });

            // ドラッグ&ドロップ機能
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#ff1493';
                dropZone.style.background = 'rgba(255,20,147,0.2)';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.borderColor = 'rgba(255,20,147,0.5)';
                dropZone.style.background = 'rgba(255,20,147,0.05)';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                handleImageDrop(e);
                dropZone.style.borderColor = 'rgba(255,20,147,0.5)';
                dropZone.style.background = 'rgba(255,20,147,0.05)';
            });

            // エディター内でのドラッグ&ドロップ
            editor.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            editor.addEventListener('drop', (e) => {
                e.preventDefault();
                handleImageDrop(e);
            });
        }

        function formatText(format) {
            const editor = document.getElementById('contentEditor');
            editor.focus();
            
            switch(format) {
                case 'bold':
                    document.execCommand('bold');
                    break;
                case 'italic':
                    document.execCommand('italic');
                    break;
                case 'underline':
                    document.execCommand('underline');
                    break;
                case 'red':
                    document.execCommand('foreColor', false, 'red');
                    break;
                case 'blue':
                    document.execCommand('foreColor', false, 'blue');
                    break;
            }
        }

        function resetEditor() {
            document.getElementById('contentEditor').innerHTML = '';
            document.getElementById('charCounter').textContent = '0 文字';
        }

        function insertImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = `<img src="${e.target.result}" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px;">`;
                        document.execCommand('insertHTML', false, img);
                        updateCharCount();
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function insertYouTube() {
            const url = prompt('YouTubeのURLを入力してください:');
            if (url) {
                const videoId = extractYouTubeId(url);
                if (videoId) {
                    const iframe = `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen style="max-width: 100%; margin: 10px 0; border-radius: 8px;"></iframe>`;
                    document.execCommand('insertHTML', false, iframe);
                    updateCharCount();
                } else {
                    alert('有効なYouTubeのURLを入力してください');
                }
            }
        }

        function extractYouTubeId(url) {
            const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        function handleImageDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = `<img src="${e.target.result}" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px;">`;
                        
                        // カーソル位置に挿入
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            range.deleteContents();
                            const imgElement = document.createElement('div');
                            imgElement.innerHTML = img;
                            range.insertNode(imgElement.firstChild);
                        } else {
                            document.getElementById('contentEditor').innerHTML += img;
                        }
                        updateCharCount();
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function updateCharCount() {
            const editor = document.getElementById('contentEditor');
            const counter = document.getElementById('charCounter');
            counter.textContent = editor.textContent.length + ' 文字';
        }

        async function saveToVercel() {
            const title = document.getElementById('articleTitle').value;
            const content = document.getElementById('contentEditor').innerHTML;
            const course = document.getElementById('courseSelect').value;
            
            if (!title || !content) {
                alert('タイトルと内容を入力してください');
                return;
            }

            try {
                const response = await fetch('/api/github', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        course: course
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(`記事が正常に保存されました！\nIssue #${result.issueNumber}\n${result.url}`);
                    // エディターをクリア
                    document.getElementById('articleTitle').value = '';
                    document.getElementById('contentEditor').innerHTML = '';
                    document.getElementById('charCounter').textContent = '0 文字';
                } else {
                    alert('保存に失敗しました: ' + result.error);
                    console.error('Save error:', result);
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('保存中にエラーが発生しました: ' + error.message);
            }
        }

        function previewArticle() {
            const title = document.getElementById('articleTitle').value;
            const content = document.getElementById('contentEditor').innerHTML;
            
            if (!title || !content) {
                alert('タイトルと内容を入力してください');
                return;
            }
            
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem;
                            background: #000; color: #fff;
                        }
                        h1 { color: #ff1493; }
                        img { max-width: 100%; height: auto; border-radius: 8px; }
                        iframe { max-width: 100%; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div>${content}</div>
                </body>
                </html>
            `);
        }

        function newArticle() {
            if (confirm('現在の内容をクリアして新しい記事を作成しますか？')) {
                document.getElementById('articleTitle').value = '';
                document.getElementById('contentEditor').innerHTML = '';
                document.getElementById('charCounter').textContent = '0 文字';
            }
        }

        async function listArticles() {
            try {
                const response = await fetch('https://api.github.com/repos/ICHIJO-999/love/issues?labels=article');
                const issues = await response.json();
                
                let articlesList = '記事一覧:\n\n';
                issues.forEach((issue, index) => {
                    articlesList += `${index + 1}. ${issue.title} (Issue #${issue.number})\n`;
                });
                
                alert(articlesList);
            } catch (error) {
                alert('記事一覧の取得に失敗しました');
            }
        }

        async function loadArticles(course) {
            try {
                const response = await fetch(`https://api.github.com/repos/ICHIJO-999/love/issues?labels=article,course:${course}`);
                const issues = await response.json();
                
                const articlesList = document.getElementById('articlesList');
                
                if (issues.length === 0) {
                    articlesList.innerHTML = '<p>このコースの記事はまだありません。</p>';
                    return;
                }
                
                articlesList.innerHTML = '';
                issues.forEach(issue => {
                    const articleCard = document.createElement('div');
                    articleCard.className = 'article-card';
                    articleCard.innerHTML = `
                        <h4>${issue.title}</h4>
                        <div class="article-meta">
                            作成日: ${new Date(issue.created_at).toLocaleDateString('ja-JP')} | 
                            コース: ${course} | 
                            エディター: TIPS Level Editor Vercel版
                        </div>
                        <div class="article-content">${issue.body.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>
                    `;
                    articlesList.appendChild(articleCard);
                });
            } catch (error) {
                document.getElementById('articlesList').innerHTML = '<p>記事の読み込みに失敗しました。</p>';
            }
        }

        // Enterキーでログイン
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>
