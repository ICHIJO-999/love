<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE secret - 統合サイト Enhanced</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Hiragino Sans", sans-serif;
            background: #000; color: #fff; min-height: 100vh;
        }
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255,20,147,0.1) 0%, rgba(0,0,0,0.8) 50%, #000 100%);
            z-index: -1;
        }
        .container {
            max-width: 1200px; margin: 0 auto; padding: 2rem;
            text-align: center; min-height: 100vh; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .logo {
            font-size: 3rem; font-weight: bold; margin-bottom: 1rem;
            background: linear-gradient(45deg, #ff1493, #ff69b4, #ff1493);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; text-shadow: 0 0 30px rgba(255,20,147,0.5);
            border: 2px solid #ff1493; padding: 1rem 2rem; border-radius: 10px;
            box-shadow: 0 0 20px rgba(255,20,147,0.3), inset 0 0 20px rgba(255,20,147,0.1);
            position: fixed; top: 20px; left: 20px; font-size: 1.5rem;
        }
        .login-container {
            background: rgba(255,20,147,0.1); padding: 3rem; border-radius: 20px;
            border: 1px solid rgba(255,20,147,0.3); backdrop-filter: blur(10px);
            box-shadow: 0 0 50px rgba(255,20,147,0.2); max-width: 500px; width: 100%;
        }
        .login-title {
            font-size: 2.5rem; margin-bottom: 1rem;
            background: linear-gradient(45deg, #ff1493, #ff69b4);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .login-subtitle { color: #ccc; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        .form-group label {
            display: block; margin-bottom: 0.5rem; color: #ff1493; font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%; padding: 1rem; border: 2px solid rgba(255,20,147,0.3);
            border-radius: 10px; background: rgba(0,0,0,0.5); color: #fff;
            font-size: 1rem; transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: #ff1493; box-shadow: 0 0 20px rgba(255,20,147,0.3);
        }
        .btn {
            background: linear-gradient(45deg, #ff1493, #ff69b4); color: #fff;
            border: none; padding: 1rem 2rem; border-radius: 10px; font-size: 1.1rem;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease; margin: 0.5rem;
            box-shadow: 0 0 20px rgba(255,20,147,0.3);
        }
        .btn:hover {
            transform: translateY(-2px); box-shadow: 0 5px 30px rgba(255,20,147,0.4);
        }
        .btn-primary { width: 100%; }
        .password-hint {
            font-size: 0.9rem; color: #888; margin-top: 1rem; text-align: center;
        }
        .editor-container {
            display: none; max-width: 1200px; width: 100%; margin: 2rem auto;
            background: rgba(255,20,147,0.05); border-radius: 20px; padding: 2rem;
            border: 1px solid rgba(255,20,147,0.2);
        }
        .editor-title {
            font-size: 2rem; margin-bottom: 1rem; text-align: center;
            background: linear-gradient(45deg, #ff1493, #ff69b4);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .status-indicator {
            background: #28a745; color: #fff; padding: 0.5rem 1rem;
            border-radius: 20px; font-size: 0.9rem; margin-bottom: 2rem;
            display: inline-block;
        }
        .editor-section {
            background: rgba(0,0,0,0.3); border-radius: 15px; padding: 1.5rem;
            margin-bottom: 2rem; border: 1px solid rgba(255,20,147,0.2);
        }
        .section-title {
            color: #ff1493; font-size: 1.3rem; margin-bottom: 1rem; font-weight: bold;
        }
        .toolbar {
            display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;
            padding: 1rem; background: rgba(255,20,147,0.1); border-radius: 10px;
        }
        .toolbar-btn {
            background: rgba(255,20,147,0.2); color: #fff; border: 1px solid rgba(255,20,147,0.3);
            padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .toolbar-btn:hover {
            background: rgba(255,20,147,0.4); transform: translateY(-1px);
        }
        .toolbar-btn.red { background: rgba(220,20,60,0.3); border-color: #dc143c; }
        .toolbar-btn.blue { background: rgba(30,144,255,0.3); border-color: #1e90ff; }
        .content-editor {
            min-height: 300px; border: 2px solid rgba(255,20,147,0.3);
            border-radius: 10px; padding: 1rem; background: rgba(0,0,50,0.3);
            color: #fff; font-size: 1rem; line-height: 1.6; outline: none;
            position: relative; overflow-y: auto;
        }
        .content-editor:focus {
            border-color: #ff1493; box-shadow: 0 0 20px rgba(255,20,147,0.3);
        }
        .content-editor img {
            max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0;
            cursor: pointer; transition: transform 0.3s ease;
        }
        .content-editor img:hover {
            transform: scale(1.02); box-shadow: 0 5px 20px rgba(255,20,147,0.3);
        }
        .drag-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,20,147,0.2); border: 3px dashed #ff1493;
            border-radius: 10px; display: none; align-items: center; justify-content: center;
            font-size: 1.2rem; font-weight: bold; color: #ff1493;
        }
        .char-counter {
            text-align: right; color: #888; font-size: 0.9rem; margin-top: 0.5rem;
        }
        .drop-zone {
            border: 2px dashed rgba(255,20,147,0.5); border-radius: 10px;
            padding: 2rem; text-align: center; color: #888; margin-bottom: 1rem;
            transition: all 0.3s ease; cursor: pointer;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #ff1493; background: rgba(255,20,147,0.1); color: #ff1493;
        }
        .action-buttons {
            display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 2rem;
        }
        .student-container {
            display: none; max-width: 1000px; width: 100%; margin: 2rem auto;
        }
        .course-header {
            background: rgba(255,20,147,0.1); padding: 2rem; border-radius: 15px;
            text-align: center; margin-bottom: 2rem; border: 1px solid rgba(255,20,147,0.3);
        }
        .course-title {
            font-size: 2rem; color: #ff1493; margin-bottom: 0.5rem;
        }
        .course-description { color: #ccc; font-size: 1.1rem; }
        .articles-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem; margin-top: 2rem;
        }
        .article-card {
            background: rgba(255,20,147,0.1); border-radius: 15px; padding: 1.5rem;
            border: 1px solid rgba(255,20,147,0.2); transition: all 0.3s ease;
            cursor: pointer;
        }
        .article-card:hover {
            transform: translateY(-5px); box-shadow: 0 10px 30px rgba(255,20,147,0.3);
        }
        .article-title {
            color: #ff1493; font-size: 1.3rem; margin-bottom: 0.5rem; font-weight: bold;
        }
        .article-meta {
            color: #888; font-size: 0.9rem; margin-bottom: 1rem;
        }
        .article-preview {
            color: #ccc; line-height: 1.5; display: -webkit-box;
            -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }
        .error-message {
            background: rgba(220,20,60,0.2); color: #ff6b6b; padding: 1rem;
            border-radius: 10px; border: 1px solid rgba(220,20,60,0.3); text-align: center;
        }
        .user-info {
            position: fixed; top: 20px; right: 20px; background: rgba(255,20,147,0.2);
            padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;
            border: 1px solid rgba(255,20,147,0.3);
        }
        .image-upload-input {
            display: none;
        }
        .image-size-controls {
            display: none; position: absolute; background: rgba(0,0,0,0.8);
            padding: 0.5rem; border-radius: 5px; z-index: 1000;
        }
        .image-size-controls button {
            background: #ff1493; color: white; border: none; padding: 0.3rem 0.6rem;
            margin: 0 0.2rem; border-radius: 3px; cursor: pointer; font-size: 0.8rem;
        }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .logo { position: static; margin-bottom: 2rem; }
            .toolbar { flex-direction: column; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="#" class="logo">THE secret</a>
        <div class="user-info" id="userInfo" style="display: none;"></div>
        
        <!-- ログイン画面 -->
        <div class="login-container" id="loginContainer">
            <h1 class="login-title">THE secret</h1>
            <p class="login-subtitle">統合サイト - 管理者・受講生対応</p>
            
            <div class="form-group">
                <label for="password">パスワード</label>
                <input type="password" id="password" placeholder="パスワードを入力してください..." />
            </div>
            
            <button class="btn btn-primary" onclick="login()">Enter</button>
            
            <div class="password-hint">
                管理者: admin123 | コース1: course1 | コース2: course2 | コース3: course3
            </div>
        </div>

        <!-- 管理者エディター -->
        <div class="editor-container" id="editorContainer">
            <h2 class="editor-title">TIPS Level Editor Enhanced</h2>
            <div class="status-indicator">
                🟢 GitHub Issues API 接続済み - オンライン保存有効 - インライン画像対応
            </div>

            <div class="editor-section">
                <h3 class="section-title">記事情報</h3>
                <div class="form-group">
                    <label for="articleTitle">記事タイトル</label>
                    <input type="text" id="articleTitle" placeholder="記事のタイトルを入力してください" />
                </div>
                <div class="form-group">
                    <label for="courseSelect">対象コース</label>
                    <select id="courseSelect">
                        <option value="course1">コース1: 基礎編</option>
                        <option value="course2">コース2: 応用編</option>
                        <option value="course3">コース3: 上級編</option>
                    </select>
                </div>
            </div>

            <div class="editor-section">
                <h3 class="section-title">記事内容</h3>
                <div class="toolbar">
                    <button class="toolbar-btn" onclick="formatText('bold')">太字</button>
                    <button class="toolbar-btn" onclick="formatText('italic')">斜体</button>
                    <button class="toolbar-btn" onclick="formatText('underline')">下線</button>
                    <button class="toolbar-btn red" onclick="formatColor('red')">赤</button>
                    <button class="toolbar-btn blue" onclick="formatColor('blue')">青</button>
                    <button class="toolbar-btn" onclick="resetFormat()">リセット</button>
                    <button class="toolbar-btn" onclick="document.getElementById('imageUpload').click()">📷 画像選択</button>
                    <button class="toolbar-btn" onclick="insertYouTube()">📺 YouTube</button>
                </div>
                
                <input type="file" id="imageUpload" class="image-upload-input" accept="image/*" onchange="handleImageUpload(event)" />
                
                <div class="drop-zone" onclick="document.getElementById('imageUpload').click()">
                    📷 画像をここにドラッグ&ドロップ または クリックして選択
                    <br><small>テキスト内の任意の位置にも直接ドラッグできます</small>
                </div>
                
                <div class="content-editor" id="contentEditor" contenteditable="true" 
                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                     oninput="updateCharCount()" onpaste="handlePaste(event)">
                </div>
                <div class="drag-overlay" id="dragOverlay">
                    📷 ここに画像をドロップしてください
                </div>
                <div class="char-counter" id="charCounter">0 文字</div>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="saveToGitHub()">GitHub Issues に保存</button>
                <button class="btn" onclick="previewArticle()">プレビュー</button>
                <button class="btn" onclick="newArticle()">新規作成</button>
                <button class="btn" onclick="showArticleList()">記事一覧</button>
            </div>
        </div>

        <!-- 受講生画面 -->
        <div class="student-container" id="studentContainer">
            <h2 class="editor-title">コース記事一覧</h2>
            <div class="course-header" id="courseHeader">
                <div class="course-title" id="courseTitle">コース1: 基礎編</div>
                <div class="course-description" id="courseDescription">恋愛の基本的な考え方とアプローチ方法を学びます</div>
            </div>
            <div class="articles-grid" id="articlesGrid">
                <div class="error-message">記事の読み込みに失敗しました<br><small>エラー: 記事の取得に失敗 - 401</small></div>
            </div>
        </div>
    </div>

    <script>
        const GITHUB_TOKEN = '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';
        const GITHUB_REPO = 'ICHIJO-999/love';
        let currentUser = null;
        let currentCourse = null;

        function login() {
            const password = document.getElementById('password').value;
            const loginContainer = document.getElementById('loginContainer');
            const editorContainer = document.getElementById('editorContainer');
            const studentContainer = document.getElementById('studentContainer');
            const userInfo = document.getElementById('userInfo');

            if (password === 'admin123') {
                currentUser = 'admin';
                loginContainer.style.display = 'none';
                editorContainer.style.display = 'block';
                userInfo.style.display = 'block';
                userInfo.textContent = '管理者 - GitHub連携エディター';
            } else if (['course1', 'course2', 'course3'].includes(password)) {
                currentUser = 'student';
                currentCourse = password;
                loginContainer.style.display = 'none';
                studentContainer.style.display = 'block';
                userInfo.style.display = 'block';
                userInfo.textContent = `コース${password.slice(-1)}: ${getCourseInfo(password).name}受講生`;
                loadStudentView(password);
            } else {
                alert('パスワードが正しくありません');
            }
        }

        function getCourseInfo(course) {
            const courses = {
                'course1': { name: '基礎編', description: '恋愛の基本的な考え方とアプローチ方法を学びます' },
                'course2': { name: '応用編', description: '実践的なコミュニケーション技術と関係構築を学びます' },
                'course3': { name: '上級編', description: '長期的な関係維持と深い絆の築き方を学びます' }
            };
            return courses[course] || courses['course1'];
        }

        function loadStudentView(course) {
            const courseInfo = getCourseInfo(course);
            document.getElementById('courseTitle').textContent = `コース${course.slice(-1)}: ${courseInfo.name}`;
            document.getElementById('courseDescription').textContent = courseInfo.description;
            loadArticles(course);
        }

        async function loadArticles(course) {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues?labels=article,course:${course}&state=open`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const articles = await response.json();
                displayArticles(articles);
            } catch (error) {
                document.getElementById('articlesGrid').innerHTML = 
                    `<div class="error-message">記事の読み込みに失敗しました<br><small>エラー: ${error.message}</small></div>`;
            }
        }

        function displayArticles(articles) {
            const grid = document.getElementById('articlesGrid');
            if (articles.length === 0) {
                grid.innerHTML = '<div class="error-message">まだ記事がありません</div>';
                return;
            }

            grid.innerHTML = articles.map(article => {
                const content = article.body || '';
                const preview = content.replace(/<[^>]*>/g, '').substring(0, 150) + '...';
                return `
                    <div class="article-card" onclick="viewArticle(${article.number})">
                        <div class="article-title">${article.title}</div>
                        <div class="article-meta">
                            作成日: ${new Date(article.created_at).toLocaleDateString('ja-JP')} | 
                            コース: ${article.labels.find(l => l.name.startsWith('course:'))?.name.replace('course:', '') || 'N/A'} |
                            エディター: ${article.labels.find(l => l.name === 'tips-editor') ? 'TIPS Level Editor' : 'Standard'}
                        </div>
                        <div class="article-preview">${preview}</div>
                    </div>
                `;
            }).join('');
        }

        function viewArticle(number) {
            alert(`記事 #${number} の詳細表示機能は実装予定です`);
        }

        // エディター機能
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('contentEditor').focus();
        }

        function formatColor(color) {
            document.execCommand('foreColor', false, color);
            document.getElementById('contentEditor').focus();
        }

        function resetFormat() {
            document.execCommand('removeFormat', false, null);
            document.getElementById('contentEditor').focus();
        }

        function updateCharCount() {
            const editor = document.getElementById('contentEditor');
            const counter = document.getElementById('charCounter');
            counter.textContent = editor.textContent.length + ' 文字';
        }

        // 画像処理機能（強化版）
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                insertImageAtCursor(file);
            }
        }

        function insertImageAtCursor(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.borderRadius = '8px';
                img.style.margin = '10px 0';
                img.style.cursor = 'pointer';
                img.onclick = function() { showImageControls(this); };

                // カーソル位置に挿入
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(img);
                    range.setStartAfter(img);
                    range.setEndAfter(img);
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    // カーソルがない場合は末尾に追加
                    document.getElementById('contentEditor').appendChild(img);
                }
                
                updateCharCount();
            };
            reader.readAsDataURL(file);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dragOverlay').style.display = 'flex';
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dragOverlay').style.display = 'none';
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dragOverlay').style.display = 'none';

            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                // ドロップ位置にカーソルを設定
                const range = document.caretRangeFromPoint(event.clientX, event.clientY);
                if (range) {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
                insertImageAtCursor(files[0]);
            }
        }

        function handlePaste(event) {
            const items = event.clipboardData.items;
            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    event.preventDefault();
                    const file = item.getAsFile();
                    insertImageAtCursor(file);
                    break;
                }
            }
        }

        function showImageControls(img) {
            const controls = document.createElement('div');
            controls.className = 'image-size-controls';
            controls.innerHTML = `
                <button onclick="resizeImage(this.parentNode.previousSibling, 'small')">小</button>
                <button onclick="resizeImage(this.parentNode.previousSibling, 'medium')">中</button>
                <button onclick="resizeImage(this.parentNode.previousSibling, 'large')">大</button>
                <button onclick="removeImage(this.parentNode.previousSibling)">削除</button>
                <button onclick="this.parentNode.remove()">閉じる</button>
            `;
            
            // 既存のコントロールを削除
            const existingControls = document.querySelector('.image-size-controls');
            if (existingControls) existingControls.remove();
            
            img.parentNode.insertBefore(controls, img.nextSibling);
            controls.style.display = 'block';
        }

        function resizeImage(img, size) {
            const sizes = {
                'small': '30%',
                'medium': '60%',
                'large': '100%'
            };
            img.style.maxWidth = sizes[size];
            document.querySelector('.image-size-controls').remove();
        }

        function removeImage(img) {
            img.remove();
            document.querySelector('.image-size-controls').remove();
            updateCharCount();
        }

        function insertYouTube() {
            const url = prompt('YouTube動画のURLを入力してください:');
            if (url) {
                const videoId = extractYouTubeId(url);
                if (videoId) {
                    const iframe = document.createElement('iframe');
                    iframe.src = `https://www.youtube.com/embed/${videoId}`;
                    iframe.width = '100%';
                    iframe.height = '315';
                    iframe.frameBorder = '0';
                    iframe.allowFullscreen = true;
                    iframe.style.borderRadius = '8px';
                    iframe.style.margin = '10px 0';
                    
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        range.insertNode(iframe);
                    } else {
                        document.getElementById('contentEditor').appendChild(iframe);
                    }
                    updateCharCount();
                } else {
                    alert('有効なYouTube URLを入力してください');
                }
            }
        }

        function extractYouTubeId(url) {
            const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        async function saveToGitHub() {
            const title = document.getElementById('articleTitle').value;
            const content = document.getElementById('contentEditor').innerHTML;
            const course = document.getElementById('courseSelect').value;

            if (!title || !content) {
                alert('タイトルと内容を入力してください');
                return;
            }

            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        body: content,
                        labels: ['article', `course:${course}`, 'tips-editor', 'enhanced-editor']
                    })
                });

                if (response.ok) {
                    alert('記事が正常に保存されました！');
                    newArticle();
                } else {
                    throw new Error(`保存に失敗しました: ${response.status}`);
                }
            } catch (error) {
                alert(`エラー: ${error.message}`);
            }
        }

        function previewArticle() {
            const title = document.getElementById('articleTitle').value;
            const content = document.getElementById('contentEditor').innerHTML;
            
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>${title} - プレビュー</title>
                    <style>
                        body { font-family: "Hiragino Sans", sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; line-height: 1.6; }
                        h1 { color: #ff1493; border-bottom: 2px solid #ff1493; padding-bottom: 0.5rem; }
                        img { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; }
                        iframe { max-width: 100%; border-radius: 8px; margin: 10px 0; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div>${content}</div>
                </body>
                </html>
            `);
        }

        function newArticle() {
            document.getElementById('articleTitle').value = '';
            document.getElementById('contentEditor').innerHTML = '';
            document.getElementById('courseSelect').value = 'course1';
            updateCharCount();
        }

        function showArticleList() {
            alert('記事一覧機能は実装予定です');
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            updateCharCount();
        });
    </script>
</body>
</html>
